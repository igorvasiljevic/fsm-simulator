class State{constructor(t){this.id=t.toString(),this.name=this.id,this.transitions={},this.final=!1,this.x=0,this.y=0}setName(t){return this.name=t,this}setTransitions(t){return this.transitions=t,this}setFinal(t){return this.final=t,this}setPosition(t,e){return this.x=t,this.y=e,this}addTransition(t,e){this.transitions[t]?this.transitions[t].push(e):this.transitions[t]=[e]}removeTransition(t){delete this.transitions[t]}}class FSM{constructor(t){if(t){this.next_state_id=t.next_state_id,this.initial_state=t.initial_state.toString(),this.states=[];for(let e of t.states)this.states.push(new State(e.id).setName(e.name).setTransitions(e.transitions).setFinal(e.final).setPosition(e.x,e.y))}else this.next_state_id=0,this.initial_state=this.next_state_id.toString(),this.states=[new State(this.next_state_id).setName("S")],++this.next_state_id}getState(t){for(let e of this.states)if(e.id===t)return e}addState(){let t=new State(this.next_state_id++);return this.states.push(t),t}removeState(t){if(t!=this.initial_state){for(let e in this.states)delete this.states[e].transitions[t];for(let e in this.states)this.states[e].id===t&&this.states.splice(e,1)}}transition(t,e){let s=[];e||(s=e=[this.initial_state]);for(let i of e){let e=this.getState(i);for(let i in e.transitions){!s.includes(i)&&e.transitions[i].includes(t)&&s.push(i);for(let t of s){let e=this.getState(t);for(let t in e.transitions)!s.includes(t)&&e.transitions[t].includes(EPSILON)&&s.push(t)}}}return s}test(t,e){e||(e=this.transition("",e));for(let s of t)e=this.transition(s,e);return e}accepted(t){for(let e of t)if(this.getState(e).final)return!0;return!1}}function move(t,e,s){e=t.clientWidth>t.parentElement.clientWidth?clamp(e,t.parentElement.clientWidth-t.clientWidth,0):clamp(e,0,t.parentElement.clientWidth-t.clientWidth),s=t.clientHeight>t.parentElement.clientHeight?clamp(s,t.parentElement.clientHeight-t.clientHeight,0):clamp(s,0,t.parentElement.clientHeight-t.clientHeight),t.style.transform=`translate(${e}px, ${s}px)`}function Events(t,e){const s=()=>{t.onmouseup=null,t.onmousemove=null,t.ondblclick=null,t.onmouseleave=null,t.ontouchend=null,t.ontouchmove=null,t.ontouchcancel=null};t.onmousedown=(i=>{i.stopPropagation();let n=i.target;t.onmouseleave=s,t.onmouseup=(s=>{s.stopPropagation(),t.onmousemove=null,e.click&&e.click(i)}),e.move&&(t.onmousemove=(i=>{i.preventDefault(),t.onmouseup=s,e.move(n,i)})),e.dblclick&&(t.ondblclick=(t=>{e.dblclick(t)}))}),t.onwheel=e.wheel;let i={};t.ontouchstart=(n=>{t.ontouchcancel=s,t.ontouchend=(t=>{for(let e of t.changedTouches)delete i[e.target.id]});for(let t of n.changedTouches)i[t.target.id]={x:t.pageX,y:t.pageY};e.move&&(t.ontouchmove=(t=>{t.preventDefault();for(let s of t.changedTouches)i[s.target.id]&&(t.movementX=s.pageX-i[s.target.id].x,t.movementY=s.pageY-i[s.target.id].y,i[s.target.id].x=s.pageX,i[s.target.id].y=s.pageY,e.move(s.target,t))}))})}const state_element_template='<div class="state">\n        <svg class="svg no_events" width="54" height="54" xmlns="http://www.w3.org/2000/svg">\n            <ellipse class="fill no_events" cx="50%" cy="50%" rx="25" ry="25" stroke-width="4" stroke="black" fill="white"></ellipse>\n            <ellipse class="final disabled no_events" cx="50%" cy="50%" rx="20" ry="20" stroke-width="4" stroke="black" fill="none"></ellipse>\n        </svg>\n        <input type="text" autocomplete="off" spellcheck="false" class="state_text not_selectable no_events" value="S">\n    </div>',transition_element_template='<div class="transition">\n        <svg class="svg" width="50" height="26" xmlns="http://www.w3.org/2000/svg">\n            <line class="no_events" stroke="#000" x1="0" y1="13" x2="100%" y2="13" stroke-width="2"></line>\n            <line class="no_events" stroke="#000" x1="0" y1="13" x2="10" y2="8" stroke-width="2"></line>\n            <line class="no_events" stroke="#000" x1="0" y1="13" x2="10" y2="18" stroke-width="2"></line>\n        </svg>\n        <input type="text" autocomplete="off" spellcheck="false" class="transition_text not_selectable no_events">\n    </div>',loop_element_template='<div class="transition">\n        <svg class="svg" width="44" height="50" xmlns="http://www.w3.org/2000/svg">           \n            <ellipse class="no_events" stroke="#000" stroke-width="2" cx="50%" cy="28" rx="19" ry="19" fill="none"></ellipse>\n            <line class="no_events" stroke="#000" x1="36" y1="31" x2="35" y2="43.5" stroke-width="2" fill="none"></line>\n            <line class="no_events" stroke="#000" x1="45" y1="36" x2="34.5" y2="43.5" stroke-width="2" fill="none"></line>\n        </svg>\n        <input type="text" autocomplete="off" spellcheck="false" class="loop_text transition_text not_selectable no_events">\n    </div>';class FSMCanvas{constructor(t){this.frame=t,this.canvas=t.getElementsByClassName("fsm_canvas")[0],this.state_element_template=stringToHTMLElement(state_element_template),this.transition_element_template=stringToHTMLElement(transition_element_template),this.loop_element_template=stringToHTMLElement(loop_element_template),this.string_input_index=-1;let e=this.frame.getElementsByClassName("toolbar")[0];this.fsm_string=this.frame.getElementsByClassName("fsm_string")[0],this.fake_fsm_string=this.frame.getElementsByClassName("fsm_string")[1],"100%"===this.frame.style.height&&(this.frame.style.position="absolute",this.frame.getElementsByClassName("bottom_bar")[0].style.position="fixed"),move(this.canvas,(this.frame.clientWidth-this.canvas.clientWidth)/2,(this.frame.clientHeight-this.canvas.clientHeight)/2),this.canvasWidth=this.canvas.clientWidth,this.clientHeight=this.canvas.clientHeight,window.onresize=(t=>{move(this.canvas,(this.frame.clientWidth-this.canvas.clientWidth)/2,(this.frame.clientHeight-this.canvas.clientHeight)/2),this.canvasWidth=this.canvas.clientWidth,this.clientHeight=this.canvas.clientHeight,this.repositionStates(),this.repositionTransitions()}),Events(this.canvas,{click:t=>{t.target.classList.contains("state")?this.stateClicked(t.target.id):t.target.classList.contains("svg")&&t.target.parentElement.classList.contains("transition")&&this.transition_clicked(t.target.parentElement.from_id,t.target.parentElement.to_id)},dblclick:t=>{if(t.target.classList.contains("fsm_canvas")){let e=t.target.getBoundingClientRect();this.fsm.addState().setPosition(t.clientX-e.x-this.canvas.clientWidth/2,t.clientY-e.y-this.canvas.clientHeight/2),this.draw()}else if(t.target.classList.contains("state")){let e=t.target.getElementsByClassName("state_text")[0];e.focus(),e.setSelectionRange(0,e.value.length)}else if(t.target.classList.contains("svg")&&t.target.parentElement.classList.contains("transition")){let e=t.target.parentElement.getElementsByClassName("transition_text")[0];e.focus(),e.setSelectionRange(0,e.value.length)}},move:(t,e)=>{if(t.classList.contains("fsm_canvas")){if(!e.touches||1===e.touches.length){let s=t.getBoundingClientRect(),i=t.parentElement.getBoundingClientRect();move(t,s.x-i.x+e.movementX,s.y-i.y+e.movementY)}}else if(t.classList.contains("state")){e.preventDefault();let s=t.getBoundingClientRect(),i=t.parentElement.getBoundingClientRect();move(t,s.x-i.x+e.movementX,s.y-i.y+e.movementY);let n=this.fsm.getState(t.id);n.x=s.x+s.width/2-i.x+e.movementX-this.canvas.clientWidth/2,n.y=s.y+s.height/2-i.y+e.movementY-this.canvas.clientHeight/2,this.repositionTransitions()}}}),this.frame.getElementsByClassName("toggle_toolbar")[0].onmousedown=(t=>{e.classList.contains("toolbar_show")?(e.classList.remove("toolbar_show"),this.tool&&e.querySelector(`#${this.tool}`).classList.remove("tool_selected"),delete this.tool):e.classList.add("toolbar_show")});for(let t of e.children)t.onmousedown=(s=>{delete this.from_state_selected,this.tool===t.id?(delete this.tool,t.classList.remove("tool_selected")):(this.tool&&e.querySelector(`#${this.tool}`).classList.remove("tool_selected"),this.tool=t.id,t.classList.add("tool_selected"))});this.stateClicked=(t=>{if(this.tool&&this.reset(),"delete"===this.tool)this.fsm.removeState(t),this.draw();else if("initial"===this.tool)this.fsm.initial_state=t,this.draw();else if("final"===this.tool){let e=this.fsm.getState(t);e.setFinal(!e.final),this.draw()}else if("transition"===this.tool){let e=this.getState(t);if(this.from_state_selected){let e=this.fsm.getState(this.from_state_selected);e.transitions[t]||(e.addTransition(t,""),this.draw());for(let e of this.canvas.getElementsByClassName("transition"))if(e.from_id===this.from_state_selected&&e.to_id===t){e.getElementsByClassName("transition_text")[0].focus()}delete this.from_state_selected}else this.from_state_selected=t,e.getElementsByClassName("fill")[0].classList.add("state_selected")}}),this.transition_clicked=((t,e)=>{"delete"===this.tool&&(this.fsm.getState(t).removeTransition(e),this.draw())}),this.fake_fsm_string.innerText=this.fsm_string.value,this.fake_fsm_string.title=this.fsm_string.value,this.fsm_string.onkeydown=(t=>{"Escape"!==t.key&&27!==t.keyCode&&"Enter"!==t.key&&13!==t.keyCode||this.fsm_string.blur()}),this.fsm_string.onblur=(()=>{this.fake_fsm_string.innerText=this.fsm_string.value,this.fake_fsm_string.title=this.fsm_string.value,this.fake_fsm_string.classList.remove("disabled")}),this.fsm_string.onchange=(()=>{this.reset()}),this.fake_fsm_string.onmousedown=(t=>{t.preventDefault(),this.fake_fsm_string.classList.add("disabled"),this.fsm_string.focus()}),this.frame.getElementsByClassName("step")[0].onmousedown=(t=>{this.step()}),this.frame.getElementsByClassName("run")[0].onmousedown=(t=>{this.run()})}setFSM(t){this.fsm=t}setString(t){this.fsm_string.value=t,this.fsm_string.onchange()}step(){this.string_input_index<0&&this.highlightCurrentStates([]);let t=this.fsm_string.value[this.string_input_index];this.current_states=this.fsm.transition(t,this.current_states),this.highlightCurrentStates(this.current_states),this.string_input_index++,this.string_input_index>=this.fsm_string.value.length&&(this.highlightFinal(this.current_states),this.string_input_index=-1,delete this.current_states),this.stylizeInputString()}run(){let t=this.fsm_string.value.slice(this.string_input_index<0?0:this.string_input_index);t=t.split(""),this.current_states=this.fsm.test(t,this.current_states);let e=this.current_states;this.reset(),this.highlightFinal(e)}getState(t){for(let e of this.canvas.getElementsByClassName("state"))if(e.id===t)return e}highlightCurrentStates(t){for(let e of this.fsm.states)t.includes(e.id)?this.getState(e.id).getElementsByClassName("fill")[0].classList.add("state_current"):this.getState(e.id).getElementsByClassName("fill")[0].classList.remove("state_current","state_accepted","state_not_accepted")}highlightFinal(t){let e=this.fsm.accepted(t);for(let s of this.fsm.states)t.includes(s.id)&&(s.final?this.getState(s.id).getElementsByClassName("fill")[0].classList.add("state_accepted"):e?this.getState(s.id).getElementsByClassName("fill")[0].classList.add("state_current"):this.getState(s.id).getElementsByClassName("fill")[0].classList.add("state_not_accepted"))}centerStates(){for(let t of this.fsm.states)t.x+=this.canvas.clientWidth/2,t.y+=this.canvas.clientHeight/2}move(t,e,s){t.style.transform=`translate(${e}px, ${s}px)`}draw(){this.fsm&&(this.canvas.innerHTML="",this.drawStates(),this.drawTransitions())}drawStates(){for(let t of this.fsm.states){let e=this.state_element_template.cloneNode(!0),s=e.getElementsByClassName("state_text")[0];this.canvas.appendChild(e),e.id=t.id,s.value=t.name,t.final&&e.getElementsByClassName("final")[0].classList.remove("disabled"),t.id===this.fsm.initial_state&&this.drawArrowInto(t),move(e,t.x+(this.canvas.clientWidth-e.clientWidth)/2,t.y+(this.canvas.clientHeight-e.clientHeight)/2),s.onkeydown=(t=>{"Escape"!==t.key&&27!==t.keyCode&&"Enter"!==t.key&&13!==t.keyCode||s.blur()}),s.onblur=(()=>{s.value?t.name=s.value:s.value=t.name})}}repositionStates(){for(let t of this.canvas.getElementsByClassName("state")){let e=this.fsm.getState(t.id);move(t,e.x+(this.canvas.clientWidth-t.clientWidth)/2,e.y+(this.canvas.clientHeight-t.clientHeight)/2)}}drawTransitions(){for(let t of this.canvas.getElementsByClassName("state")){let e=this.fsm.getState(t.id);for(let s in e.transitions){let i,n,a,l=this.fsm.getState(s);if(e&&l){if(e.id===l.id)i=this.loop_element_template.cloneNode(!0),n=i.getElementsByClassName("transition_text")[0],a=i.getElementsByClassName("svg")[0],this.canvas.appendChild(i),i.from_id=e.id,i.to_id=l.id,n.value=e.transitions[s].join(","),move(i,e.x+(this.canvas.clientWidth-i.clientWidth)/2,e.y-40+(this.canvas.clientHeight-i.clientHeight)/2);else{i=this.transition_element_template.cloneNode(!0),n=i.getElementsByClassName("transition_text")[0],a=i.getElementsByClassName("svg")[0],this.canvas.appendChild(i),i.from_id=e.id,i.to_id=l.id;let o=e.x,h=e.y,r=l.x,c=l.y;n.value=e.transitions[s].join(",");let m=distance(o,h,r,c)-t.clientWidth;a.style.width=m,move(i,(o+r+this.canvas.clientWidth-i.clientWidth)/2,(h+c+this.canvas.clientHeight-i.clientHeight)/2);let d=Math.atan2(h-c,o-r);a.style.transform=`rotate(${d}rad)`}n.onkeydown=(t=>{"Escape"!==t.key&&27!==t.keyCode&&"Enter"!==t.key&&13!==t.keyCode||n.blur()}),n.onblur=(()=>{n.value?e.transitions[s]=n.value.split(",").filter(t=>t):e.transitions[s].join()?n.value=e.transitions[s].join(","):(delete e.transitions[s],i.remove())})}}}}repositionTransitions(){for(let t of this.canvas.getElementsByClassName("transition")){let e=this.fsm.getState(t.from_id),s=this.fsm.getState(t.to_id),i=this.getState(t.from_id);if(e)if(e.id===s.id)move(t,e.x+(this.canvas.clientWidth-t.clientWidth)/2,e.y-40+(this.canvas.clientHeight-t.clientHeight)/2);else{let n=e.x,a=e.y,l=s.x,o=s.y,h=t.getElementsByClassName("svg")[0],r=distance(n,a,l,o)-i.clientWidth;h.style.width=r,move(t,(n+l+this.canvas.clientWidth-t.clientWidth)/2,(a+o+this.canvas.clientHeight-t.clientHeight)/2);let c=Math.atan2(a-o,n-l);h.style.transform=`rotate(${c}rad)`}else move(t,s.x-57.5+(this.canvas.clientWidth-t.clientWidth)/2,s.y+(this.canvas.clientHeight-t.clientHeight)/2)}}drawArrowInto(t){let e=this.transition_element_template.cloneNode(!0),s=e.getElementsByClassName("transition_text")[0],i=e.getElementsByClassName("svg")[0];this.canvas.appendChild(e),e.to_id=t.id,i.style.width=115-this.getState(t.id).clientWidth,move(e,t.x-57.5+(this.canvas.clientWidth-e.clientWidth)/2,t.y+(this.canvas.clientHeight-e.clientHeight)/2),i.style.transform=`rotate(${Math.PI}rad)`,s.value=" Start",s.style.textAlign="left",i.onmousedown=(t=>{t.stopPropagation()})}stylizeInputString(){let t=this.fsm_string.value;this.string_input_index<0||this.string_input_index>=t?this.fake_fsm_string.innerText=t:(this.fake_fsm_string.innerHTML=t.slice(0,this.string_input_index)+`<span class="inputSelected">${t[this.string_input_index]}</span>`+t.slice(this.string_input_index+1,t.length),this.fake_fsm_string.scrollLeft=(this.string_input_index-10)*(this.fake_fsm_string.scrollWidth/t.length))}reset(){delete this.current_states,this.string_input_index=-1,this.stylizeInputString(),this.draw()}}